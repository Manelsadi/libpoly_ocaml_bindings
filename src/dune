(rule
 (targets c_flags.sexp c_library_flags.sexp c_flags.lines)
 (deps (:discover config/discover.exe))
 (action (run %{discover} -system %{ocaml-config:system})))

(rule
  (targets libpoly_ext.ml libpoly_ext_stubs.c)
  (deps (:first-dep libpoly_ext.c.ml) c_flags.lines)
  (action (chdir %{workspace_root} (run %{bin:ppx_cstubs} -I %{lib:zarith:.} %{first-dep} -o %{targets} -- %{read-lines:c_flags.lines}))))

(library
 (name libpoly)
 (public_name libpoly_bindings)
 (c_names libpoly_ext_stubs)
 (c_flags (:include c_flags.sexp))
 (libraries ctypes ctypes.foreign ctypes-zarith sexplib containers ppx_cstubs)
 (flags (:standard -cclib -lyices -ccopt "$LDFLAGS"))
 (preprocess (pps ppx_deriving.std ppx_optcomp))
 (synopsis "libpoly bindings")
)

(env (dev (flags (:standard -warn-error -A))))
